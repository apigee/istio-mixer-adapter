// Copyright 2018 Google LLC
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

// $title: Apigee istio-mixer-adapter
// $description: This adapter for Istio's Mixer brings Apigee's distributed policy checks and analytics to Istio.
// $location: https://github.com/apigee/istio-mixer-adapter
//
// The Apigee istio-mixer-adapter provides Apigee's distributed authentication and quota policy checks
// as well as the ingestion of Istio telemetry for analysis and reporting.
// For additional information or support please contact anchor-prega-support@google.com.
//
// This adapter supports the [authorization template](https://istio.io/docs/reference/config/policy-and-telemetry/templates/authorization/).
// and Apigee's [analytics template](https://istio.io/docs/reference/config/policy-and-telemetry/templates/authorization/).
//
// Example config:
//
// ```yaml
//apiVersion: config.istio.io/v1alpha2
//kind: apigee
//metadata:
//  name: apigee-handler
//  namespace: istio-system
//spec:
//  apigee_base: https://istioservices.apigee.net/edgemicro
//  customer_base: https://myorg-test.apigee.net/istio-auth
//  org_name: myorg
//  env_name: test
//  key: 5f1132b7ff037fa187463c324d029ca26de28b7279df0ea161
//  secret: fa147e8afc35219b7e1db688c609196923f663b5e835975
//  temp_dir: "/tmp/apigee-istio"
//  server_timeout_secs: 60
//  products:
//    refresh_rate_mins: 1
//  analytics:
//    legacy_endpoint: false
//    file_limit: 1024
//  api_key_claim:
// ```
package config;

option go_package="config";

import "gogoproto/gogo.proto";

option (gogoproto.goproto_getters_all) = false;
option (gogoproto.equal_all) = false;
option (gogoproto.gostring_all) = false;

// The Configuration for the Apigee adapter provides information on how the adapter should contact
// the Apigee proxies and how it should operate. Running the `apigee-istio provision` CLI command
// will ensure that all proxies are installed into your Apigee environment and generate this file
// with all required settings for you.
// For additional information on this adapter or support please contact anchor-prega-support@google.com.
message Params {
    // Apigee Base is the URI for a shared proxy on Apigee.
    // Required.
    string apigee_base   = 1;
    // Customer Base is the URI for an organization-specific proxy on Apigee.
    // Required.
    string customer_base = 2;
    // Org Name is the name of the organization on Apigee.
    // Required.
    string org_name      = 3;
    // Env Name is the name of the environment on Apigee.
    // Required.
    string env_name      = 4;
    // Key is used to authenticate to the Apigee proxy endpoints, generated during provisioning.
    // Required.
    string key           = 5;
    // Secret is used to authenticate to the Apigee proxy endpoints, generated during provisioning.
    // Required.
    string secret        = 6;

    // The local directory to be used by the adapter for temporary files.
    // Optional. Default: "/tmp/apigee-istio".
    string temp_dir = 7;

    // The http timeout to be used for adapter connections to services.
    // Optional. Default: 60.
    int64 server_timeout_secs = 8;

    // The name of a JWT claim from which to look for an api_key.
    // Optional. Default: none.
    string api_key_claim = 9;

    // Options specific to to products handling.
    message product_options {
        // The rate at which the list of products is refreshed from Apigee in minutes.
        // Optional. Default: 1.
        int64 refresh_rate_mins = 1;
    }
    // Options specific to to products handling.
    product_options products = 15;

    // Options specific to to analytics handling.
    message analytics_options {
        // If true, use legacy direct communication analytics protocol instead of buffering. Must be true for OPDK.
        // Optional. Default: false.
        bool legacy_endpoint = 1;
        // The number of analytics files that can be buffered before oldest files are dropped.
        // Optional. Default: 1024.
        int64 file_limit = 2;
    }
    // Options specific to to analytics handling.
    analytics_options analytics = 16;
}
